<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3D Spherical Voronoi Tag Cloud</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: sans-serif; color: white; }
        canvas { display: block; }
        #controls {
            position: absolute; top: 10px; left: 10px; 
            background: rgba(0, 0, 0, 0.8); padding: 15px; 
            border-radius: 8px; width: 250px; border: 1px solid #444;
        }
        .row { margin-bottom: 10px; display: flex; flex-direction: column; }
        label { font-size: 12px; margin-bottom: 4px; color: #aaa; }
        input { width: 100%; }
        h3 { margin: 0 0 10px 0; font-size: 16px; color: #00d4ff; }
    </style>
</head>
<body>

<div id="controls">
    <h3>Sphere Controls</h3>
    <div class="row">
        <label>Point Count: <span id="countVal">100</span></label>
        <input type="range" id="count" min="10" max="500" value="100">
    </div>
    <div class="row">
        <label>Jitter (Randomness): <span id="jitterVal">0.2</span></label>
        <input type="range" id="jitter" min="0" max="1" step="0.01" value="0.2">
    </div>
    <div class="row">
        <label>Cell Opacity</label>
        <input type="range" id="opacity" min="0" max="1" step="0.1" value="0.3">
    </div>
    <div class="row">
        <label>Tag Size</label>
        <input type="range" id="tagSize" min="0.1" max="2" step="0.1" value="0.8">
    </div>
    <div class="row">
        <label>Rotation Speed</label>
        <input type="range" id="speed" min="0" max="0.02" step="0.001" value="0.005">
    </div>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "d3-geo-voronoi": "https://cdn.skypack.dev/d3-geo-voronoi@2"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { geoVoronoi } from 'd3-geo-voronoi';

    // --- Setup Scene ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 5;

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    const group = new THREE.Group();
    scene.add(group);

    // --- State & UI ---
    const params = {
        count: 100,
        jitter: 0.2,
        opacity: 0.3,
        tagSize: 0.8,
        speed: 0.005
    };

    const updateLabel = (id, val) => document.getElementById(id + 'Val').innerText = val;

    // --- Generators ---
    function generatePoints(n, jitter) {
        const pts = [];
        const phi = Math.PI * (Math.sqrt(5.) - 1.); // golden angle

        for (let i = 0; i < n; i++) {
            let y = 1 - (i / (n - 1)) * 2; 
            let radius = Math.sqrt(1 - y * y);
            let theta = phi * i;

            // Convert to spherical coords
            let lat = Math.asin(y) * (180 / Math.PI);
            let lon = (theta % (2 * Math.PI)) * (180 / Math.PI);

            // Apply Jitter
            lat += (Math.random() - 0.5) * 20 * jitter;
            lon += (Math.random() - 0.5) * 20 * jitter;

            pts.push([lon, lat]);
        }
        return pts;
    }

    function createTagTexture(text) {
        const canvas = document.createElement('canvas');
        canvas.width = 256;
        canvas.height = 64;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'rgba(0, 212, 255, 0.8)';
        ctx.fillRect(0, 0, 256, 64);
        ctx.font = 'bold 32px sans-serif';
        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        ctx.fillText(text, 128, 45);
        return new THREE.CanvasTexture(canvas);
    }

    function buildWorld() {
        // Clear previous
        while(group.children.length > 0) { 
            const obj = group.children[0];
            if(obj.geometry) obj.geometry.dispose();
            group.remove(obj); 
        }

        const pts = generatePoints(params.count, params.jitter);
        const v = geoVoronoi(pts);
        const geojson = v.polygons();

        // 1. Draw Voronoi Cells
        geojson.features.forEach((feature, i) => {
            const coords = feature.geometry.coordinates[0];
            const points = [];
            coords.forEach(p => {
                const phi = (90 - p[1]) * (Math.PI / 180);
                const theta = (p[0] + 180) * (Math.PI / 180);
                points.push(new THREE.Vector3().setFromSphericalCoords(2, phi, theta));
            });

            // Create Cell Shape
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.MeshBasicMaterial({
                color: new THREE.Color().setHSL(i/params.count, 0.8, 0.5),
                transparent: true,
                opacity: params.opacity,
                side: THREE.DoubleSide
            });
            
            // Note: This is a simple wireframe/fan approach for the demo
            const line = new THREE.LineLoop(geometry, material);
            group.add(line);
        });

        // 2. Draw Tags (Sprites)
        const tagMaterial = new THREE.SpriteMaterial({ map: createTagTexture("POINT") });
        pts.forEach((p, i) => {
            const phi = (90 - p[1]) * (Math.PI / 180);
            const theta = (p[0] + 180) * (Math.PI / 180);
            const pos = new THREE.Vector3().setFromSphericalCoords(2.1, phi, theta);

            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ 
                map: createTagTexture(`#${i}`),
                color: 0xffffff 
            }));
            sprite.position.copy(pos);
            sprite.scale.set(params.tagSize * 0.5, params.tagSize * 0.125, 1);
            group.add(sprite);
        });
    }

    // --- Listeners ---
    document.querySelectorAll('input').forEach(el => {
        el.addEventListener('input', (e) => {
            params[e.target.id] = parseFloat(e.target.value);
            if(document.getElementById(e.target.id + 'Val')) {
                updateLabel(e.target.id, e.target.value);
            }
            buildWorld();
        });
    });

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // --- Render Loop ---
    function animate() {
        requestAnimationFrame(animate);
        group.rotation.y += params.speed;
        group.rotation.x += params.speed * 0.2;
        controls.update();
        renderer.render(scene, camera);
    }

    buildWorld();
    animate();

</script>
</body>
</html>